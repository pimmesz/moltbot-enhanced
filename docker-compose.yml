# Moltbot Unraid - Docker Compose for local testing
# Copy .env.example to .env and configure before running

services:
  moltbot:
    build:
      context: .
      dockerfile: Dockerfile
      # For faster local development, build only for your platform
      # Comment out for multi-platform builds (amd64 + arm64)
      platforms:
        - linux/amd64
    image: moltbot-unraid:local
    container_name: moltbot
    restart: unless-stopped
    
    ports:
      - "18789:18789"
    
    volumes:
      # Persistent configuration
      - ./config:/config
    
    environment:
      # Unraid defaults
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      
      # Gateway configuration
      - MOLTBOT_PORT=${MOLTBOT_PORT:-18789}
      - MOLTBOT_BIND=${MOLTBOT_BIND:-lan}
      - MOLTBOT_TOKEN=${MOLTBOT_TOKEN:-}
      
      # AI Provider (at least one required)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    
    # Security hardening (optional, uncomment for production)
    # read_only: true
    # tmpfs:
    #   - /tmp:rw,noexec,nosuid,size=100m
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - CHOWN
    #   - SETGID
    #   - SETUID
    # security_opt:
    #   - no-new-privileges:true
    
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:18789/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
